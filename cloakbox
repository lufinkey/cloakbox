#!/bin/bash

readonly EXITCODE_BAD_ARGS=28

base_dir=$(dirname "${BASH_SOURCE[0]}")
prog_name=cloakbox

function setup
{
	mkdir -p "openvpn"
	mkdir -p "shared/.$prog_name"
	mkdir -p "shared/downloads"

	vagrant plugin install vagrant-vbguest
	vagrant plugin install vagrant-sshfs

	touch "shared/.$prog_name/setup_done"
}

function escape-string
{
	str="$1"
	escaped_str=${str//"'"/"'\"'\"'"}
	echo "'${escaped_str}'"
}

function build-command-string
{
	cmd=
	arg_counter=1
	while [ $arg_counter -le $# ]
	do
		arg=${!arg_counter}
		escaped_arg=$(escape-string "$arg")
		if [ -z "$cmd" ]
		then
			cmd="$escaped_arg"
		else
			cmd="$cmd $escaped_arg"
		fi
		arg_counter=$(($arg_counter+1))
	done
	echo "$cmd"
}

if [ "$1" == "setup" ]
then
	cd "$base_dir"
	setup
elif [ "$1" == "start" ]
then
	cd "$base_dir"
	if [ ! -f "shared/.$prog_name/setup_done" ]
	then
		setup
	fi
	vagrant up
elif [ "$1" == "stop" ]
then
	cd "$base_dir"
	vagrant halt
elif [ "$1" == "download" ]
then
	if [ "$2" == "add" ]
	then
		url="$3"
		if [ -z "$url" ]
		then
			>&2 echo "add requires a torrent path, URL, or magnet link to be given"
			# TODO show usage
			exit $EXITCODE_BAD_ARGS
		elif [[ "$url" =~ ^[0-9a-zA-Z_\-]+:\/\/.* ]] || [[ "$url" =~ magnet:\?xt=.* ]]
		then
			filename=
		else
			filename="download_"$(cat /dev/urandom | tr -cd 'a-f0-9' | head -c 16)
			cp "$url" "$base_dir/shared/.$prog_name/tmp/$filename"
			url="/shared/.$prog_name/tmp/$filename"
		fi
		cd "$base_dir"
		args=$(build-command-string "$url")
		vagrant ssh -c "cloakbox-download-manager add $args" -- -q
		retval=$?
		if [ -n "$filename" ]
		then
			rm -rf "shared/.$prog_name/tmp/$filename"
		fi
		exit $retval
	elif [ "$2" == "remove" ] || [ "$2" == "list" ] || [ "$2" == "status" ]
	then
		subcommand="$2"
		if [ $# -le 2 ]
		then
			shift
			shift
			args=
		else
			shift
			shift
			args=$(build-command-string "$@")
		fi
		vagrant ssh -c "cloakbox-download-manager $subcommand $args" -- -q
		retval=$?
		exit $retval
	else
		if [ -z "$2" ]
		then
			# TODO echo usage
			echo "you must give a subcommand"
			exit $EXITCODE_BAD_ARGS
		else
			echo "unrecognized subcommand $2"
			exit $EXITCODE_BAD_ARGS
		fi
	fi
elif [ "$1" == "updatevpn" ]
then
	cd "$base_dir"
	if [ ! -f "shared/.$prog_name/setup_done" ]
	then
		setup
	fi
	# TODO mutex lock this command
	vagrant up
	mkdir -p "shared/.$prog_name/tmp"
	rm -rf "shared/.$prog_name/tmp/openvpn"
	cp -r "openvpn" "shared/.$prog_name/tmp/openvpn"
	cmds_to_run=$(cat <<EOF
sudo service openvpn stop
cd /etc/openvpn
files=(*)
for file in "$files"
do
	if [ "$file" != "update-resolv-conf" ]
	then
		sudo rm -rf "$file"
	fi
done
sudo cp -n -t /etc/openvpn/ /shared/.$prog_name/tmp/openvpn/*
rm -rf /shared/.$prog_name/tmp/openvpn
sudo service openvpn start
EOF
	)
	echo "setting up openvpn inside of cloakbox"
	vagrant ssh -c "$cmds_to_run"
	sleep 1
	# Restart VM after updating openvpn settings
	vagrant halt
	vagrant up
elif [ "$1" == "destroy" ]
then
	clean=false
	arg_counter=2
	while [ $arg_counter -le $# ]
	do
		arg=${!arg_counter}
		if [ "$arg" == "-c" ] || [ "$arg" == "--clean" ]
		then
			clean=true
		else
			>&2 echo "unrecognized argument $arg"
			exit $EXITCODE_BAD_ARGS
		fi
		arg_counter=$(($arg_counter+1))
	done

	cd "$base_dir"
	vagrant destroy -f
	if $clean
	then
		rm -rf .vagrant
		rm -rf shared/*
		rm -rf *.log
	fi
fi

